<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>三角洲交易行 · 自动提醒</title>
<meta name="description" content="自动从 market-today.json 拉取当日中位价M，计算买卖触发与保护价，按时间生成提醒。">
<style>
  :root{--bg:#0b1020;--panel:#121a2b;--muted:#7b8aa2;--txt:#e7efff;--ac:#58c1ff;--border:#1f2a44;--card:#0f1626}
  html,body{height:100%} body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, #112042 0%, rgba(17,32,66,0) 70%), var(--bg);color:var(--txt);font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft Yahei",Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.25);margin-bottom:16px}
  h1{font-size:20px;margin:0 0 4px} .muted{color:var(--muted)} .tag{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#0a1221;color:#93a9cf}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  input,select{width:100%;padding:10px 12px;background:#0c1323;color:var(--txt);border:1px solid var(--border);border-radius:10px}
  .btn{background:linear-gradient(135deg,#3aa6ff 0%,#8be9fd 100%);color:#041223;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{padding:10px 12px;text-align:left}
  thead th{font-size:12px;color:#9eb0cc;border-bottom:1px dashed var(--border)}
  tbody tr{background:var(--card);border:1px solid var(--border)}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; color:#cfe3ff}
</style>
</head>
<body>
<div class="wrap">
  <h1>三角洲交易行 · 自动提醒</h1>
  <div class="muted">数据源：<span class="kbd">/market-today.json</span>（自动由 GitHub Actions 更新） · 时区 <span class="tag">Asia/Singapore</span></div>

  <section class="card">
    <div class="row">
      <div>
        <label>手续费率（例：6% 写 0.06）</label>
        <input id="fee" type="number" step="0.001" value="0.06">
      </div>
      <div>
        <label>提醒时间点（逗号分隔）</label>
        <input id="times" type="text" value="10:00,12:30,15:00,18:30,21:30,23:00">
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="btn" id="refresh">立即刷新数据</button>
      <button class="btn" id="exportICS" style="margin-left:8px">导出ICS（日历提醒）</button>
      <span class="muted" id="status"></span>
    </div>
  </section>

  <section class="card">
    <h3>今日计划</h3>
    <div id="plan"></div>
  </section>
</div>

<script>
const $ = (q, el=document)=>el.querySelector(q);
let planData = [];
let lastJSON = null;

async function loadJSON(){
  $("#status").textContent = "拉取 /market-today.json ...";
  const url = (location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/\/[^\/]*$/, '/')) + "market-today.json";
  try{
    const r = await fetch(url+"?t="+Date.now(), {cache:"no-cache"});
    const j = await r.json();
    lastJSON = j;
    $("#status").textContent = "已更新："+(j.date||"") + " · SKU数："+(j.items?.length||0);
    return j;
  }catch(e){
    $("#status").textContent = "获取失败："+e.message;
    return {date:"", items:[]};
  }
}

function buildPlan(items, fee, timesStr){
  const times = timesStr.split(",").map(s=>s.trim()).filter(Boolean);
  const plan = [];
  const map = new Map(items.map(i=>[i.sku, i.M]));
  // default SKUs (可在 fetcher/config.json 里增减）
  const skus = [
    {name:"5.56x45 M855", alpha:0.92, beta:1.02},
    {name:"9x19 PST", alpha:0.92, beta:1.02},
    {name:"7.62x39 PS", alpha:0.93, beta:1.015},
    {name:"7.62x51 M80", alpha:0.92, beta:1.02}
  ];
  times.forEach(t=>{
    let type = "buy";
    if(t==="12:30"||t==="18:30") type="relist";
    if(t==="23:00") type="close";
    skus.forEach(s=>{
      const M = map.get(s.name);
      const betaMin = s.alpha / (1-fee);
      if(M){
        if(type==="buy"){
          plan.push({time:t, action:"买入", sku:s.name, rule:`≤ M×${s.alpha}`, ref:(M*s.alpha).toFixed(3), note:`买到立刻挂出 ≥ M×${s.beta}`});
        }else if(type==="relist"){
          plan.push({time:t, action:"复挂", sku:s.name, rule:`未成交—2%重挂`, ref:"—", note:`保护价 ≥ M×${betaMin.toFixed(3)}`});
        }else{
          plan.push({time:t, action:"平仓", sku:s.name, rule:`全部清掉`, ref:"—", note:`保护价 ≥ M×${betaMin.toFixed(3)}`});
        }
      }else{
        plan.push({time:t, action:"提示", sku:s.name, rule:`缺少M`, ref:"—", note:`fetcher未抓到该SKU`});
      }
    });
  });
  planData = plan;
  const rows = plan.map(p=>`<tr><td>${p.time}</td><td>${p.action}</td><td>${p.sku}</td><td>${p.rule}</td><td>${p.ref}</td><td>${p.note}</td></tr>`).join("");
  $("#plan").innerHTML = `<table><thead><tr><th>时间</th><th>动作</th><th>SKU</th><th>触发</th><th>参考价(万)</th><th>备注</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function dtToICS(dt){
  const pad=n=>String(n).padStart(2,"0");
  return dt.getUTCFullYear()+pad(dt.getUTCMonth()+1)+pad(dt.getUTCDate())+"T"+pad(dt.getUTCHours())+pad(dt.getUTCMinutes())+pad(dt.getUTCSeconds())+"Z";
}

$("#exportICS").onclick = ()=>{
  if(!planData.length){ alert("请先刷新数据生成计划"); return; }
  const today = new Date();
  const yyyy = today.getFullYear(); const mm = String(today.getMonth()+1).padStart(2,"0"); const dd = String(today.getDate()).padStart(2,"0");
  let ics = "BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Delta Planner//CN\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\n";
  const now = new Date();
  planData.forEach(p=>{
    const [H,M] = p.time.split(":").map(Number);
    const start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), H, M, 0);
    const end = new Date(start.getTime() + 20*60000);
    const uid = `${p.time}-${p.sku}-${now.getTime()}@delta-planner`;
    const summary = `[${p.action}] ${p.sku} · ${p.rule}`;
    const desc = `备注：${p.note}\\nM 来源：market-today.json`;
    ics += "BEGIN:VEVENT\r\n";
    ics += "UID:"+uid+"\r\n";
    ics += "DTSTAMP:"+dtToICS(now)+"\r\n";
    ics += "DTSTART:"+dtToICS(start)+"\r\n";
    ics += "DTEND:"+dtToICS(end)+"\r\n";
    ics += "SUMMARY:"+summary+"\r\n";
    ics += "DESCRIPTION:"+desc+"\r\n";
    ics += "END:VEVENT\r\n";
  });
  ics += "END:VCALENDAR";
  const blob = new Blob([ics], {type:"text/calendar"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=`delta-auto-${yyyy}${mm}${dd}.ics`; a.click();
  URL.revokeObjectURL(url);
};

$("#refresh").onclick = async ()=>{
  const fee = parseFloat($("#fee").value||"0.06");
  const times = $("#times").value.trim();
  const j = await loadJSON();
  buildPlan(j.items||[], fee, times);
};

// auto refresh at load
$("#refresh").click();
// and auto-refresh every 10 minutes
setInterval(()=>$("#refresh").click(), 10*60*1000);
</script>
</body>
</html>
